name: Capture Server Code

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  capture:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /home/jmobrien1/food

    steps:
      - name: Show current state
        run: |
          echo "=== git status ==="
          git status || true
          echo ""
          echo "=== git diff (summary) ==="
          git diff --stat || true

      - name: Configure git identity and auth
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

      - name: Clean up any in-progress rebase
        run: |
          git rebase --abort 2>/dev/null || true
          git stash drop 2>/dev/null || true

      - name: Sync server repo to match remote
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "Server repo now at: $(git log --oneline -1)"

      - name: Check for server-only changes
        id: check
        run: |
          # After reset, any unstaged differences are server-only files
          # not yet in the remote repo
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "=== Uncommitted server-only changes ==="
            git status --short
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "Server is fully in sync with remote â€” nothing to capture"
          fi

      - name: Stage and commit server-only changes
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git add -A
          git diff --cached --stat

          git commit -m "capture: server-only changes not yet in git

          Automatically captured from the running server (10.0.0.5)."

      - name: Push to main
        if: steps.check.outputs.has_changes == 'true'
        run: git push origin main
