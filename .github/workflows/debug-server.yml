name: Debug Server

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /home/jmobrien1/food

    steps:
      - name: Docker containers
        run: |
          echo "=== docker compose ps ==="
          docker compose ps
          echo ""
          echo "=== docker ps -a (all containers) ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: API container logs (last 80 lines)
        run: |
          echo "=== API logs ==="
          docker compose logs api --tail 80 --no-color

      - name: Frontend container logs (last 30 lines)
        run: |
          echo "=== Frontend logs ==="
          docker compose logs web --tail 30 --no-color

      - name: DB container logs (last 20 lines)
        run: |
          echo "=== DB logs ==="
          docker compose logs db --tail 20 --no-color

      - name: API health check
        run: |
          echo "=== Health check ==="
          curl -sv http://localhost:8004/api/v1/health 2>&1 || echo "Health check FAILED"
          echo ""
          echo "=== Test plan endpoint (quick) ==="
          curl -sv --max-time 10 -X POST http://localhost:8004/api/v1/plans/generate \
            -H "Content-Type: application/json" \
            -d '{"ingredients":["chicken"],"equipment":["Oven"],"time_limit_minutes":60,"user_skill":"Home Cook","guest_count":2}' \
            2>&1 | head -30 || echo "Plan endpoint failed"

      - name: Server .env check
        run: |
          echo "=== .env contents (redacted) ==="
          cat .env 2>/dev/null | sed 's/=.*/=***/' || echo "No .env file"
          echo ""
          echo "=== docker compose config (env resolution) ==="
          docker compose config 2>&1 | grep -E "OLLAMA|LLM_MODEL|API_URL|PORT|CORS" || echo "No matching env vars"

      - name: Ollama status
        run: |
          echo "=== Ollama reachable from host ==="
          curl -s http://localhost:11434/api/tags | python3 -m json.tool 2>/dev/null | head -20 || echo "Ollama unreachable"
          echo ""
          echo "=== Ollama reachable from API container ==="
          docker compose exec -T api curl -s --max-time 5 http://host.docker.internal:11434/api/tags 2>&1 | head -10 || echo "Container cannot reach Ollama"
