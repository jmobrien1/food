name: Debug Server

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /home/jmobrien1/food

    steps:
      - name: Network and firewall
        run: |
          echo "=== Server IP addresses ==="
          ip addr show 2>/dev/null | grep "inet " || ifconfig 2>/dev/null | grep "inet "
          echo ""
          echo "=== Default route ==="
          ip route show default 2>/dev/null || route -n 2>/dev/null | head -5
          echo ""
          echo "=== UFW status ==="
          sudo ufw status verbose 2>/dev/null || echo "ufw not available"
          echo ""
          echo "=== iptables rules for port 8004 ==="
          sudo iptables -L -n 2>/dev/null | head -30 || echo "iptables not available"
          echo ""
          echo "=== Listening ports ==="
          ss -tlnp 2>/dev/null | grep -E "8004|3004|8000|3000|5432|5433" || netstat -tlnp 2>/dev/null | grep -E "8004|3004"

      - name: Docker containers
        run: |
          echo "=== docker compose ps ==="
          docker compose ps
          echo ""
          echo "=== docker ps -a (all containers) ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: API container logs (last 80 lines)
        run: |
          echo "=== API logs ==="
          docker compose logs api --tail 80 --no-color

      - name: API health check
        run: |
          echo "=== Health check ==="
          curl -sv http://localhost:8004/api/v1/health 2>&1 || echo "Health check FAILED"

      - name: Test Ollama from API container
        run: |
          echo "=== Ollama from host ==="
          curl -s --max-time 5 http://localhost:11434/api/tags | head -5 || echo "Ollama unreachable from host"
          echo ""
          echo "=== Ollama from container (python) ==="
          docker compose exec -T api python3 -c "
          import urllib.request, json
          try:
              r = urllib.request.urlopen('http://host.docker.internal:11434/api/tags', timeout=5)
              data = json.loads(r.read())
              print('OK - Models:', [m['name'] for m in data.get('models', [])])
          except Exception as e:
              print(f'FAILED: {e}')
          " 2>&1

      - name: Server .env check
        run: |
          echo "=== .env contents (redacted) ==="
          cat .env 2>/dev/null | sed 's/=.*/=***/' || echo "No .env file"
          echo ""
          echo "=== docker compose config (env resolution) ==="
          docker compose config 2>&1 | grep -E "OLLAMA|LLM_MODEL|API_URL|PORT|CORS" || echo "No matching env vars"
